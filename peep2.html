<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Peep</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&family=Source+Code+Pro:wght@400;500;700&display=swap" rel="stylesheet">

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-face-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-three.prod.js"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { MindARThree } from 'mindar-face-three';

    const mindarThree = new MindARThree({
      container: document.querySelector("#container"),
    });

    const { renderer, scene, camera } = mindarThree;

    scene.background = null;
    scene.background = new THREE.Color(0xffffff);

    const light = new THREE.HemisphereLight(0xffffff, 0xaaaaaa, 1);
    scene.add(light);

    const faceMesh = mindarThree.addFaceMesh();
    const textureUrls = [
      'https://luminafieldsnz.github.io/Lumina/face0.png',
      'https://luminafieldsnz.github.io/Lumina/faceblack.png',
      'https://luminafieldsnz.github.io/Lumina/facered.png',
      'https://luminafieldsnz.github.io/Lumina/facegreen.png'
    ];
    let currentTextureIndex = 0;

    const loadTexture = (url) => {
      const textureLoader = new THREE.TextureLoader();
      return new Promise((resolve) => {
        textureLoader.load(url, resolve);
      });
    };

    const updateTexture = async () => {
      const texture = await loadTexture(textureUrls[currentTextureIndex]);
      faceMesh.material.map = texture;
      faceMesh.material.needsUpdate = true;
      faceMesh.material.transparent = true;
      faceMesh.material.opacity = 1;
      faceMesh.material.blending = THREE.NormalBlending;
    };

    const changeTexture = () => {
      currentTextureIndex = (currentTextureIndex + 1) % textureUrls.length;
      updateTexture();
    };

    updateTexture();
    scene.add(faceMesh);

    const start = async () => {
      await mindarThree.start();
      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    };

    start();

    document.getElementById('changeTextureButton').addEventListener('click', changeTexture);

    let selectedMediaId = null;
    let mediaX = 0;
    let mediaY = 0;

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        const uniqueId = `media-${Date.now()}`;
        if (file.type.startsWith('video/')) {
          createVideoElement(url, file.name, uniqueId);
        } else {
          createImageElement(url, file.name, uniqueId);
        }
      }
    }

    function createImageElement(url, fileName, uniqueId) {
      const img = document.createElement('img');
      img.src = url;
      img.className = 'uploaded-media';
      img.id = uniqueId;
      img.style.position = 'absolute';

      // Center the image on upload
      img.style.left = '50%';
      img.style.top = '50%';
      img.style.transform = 'translate(-50%, -50%)';

      document.getElementById('mediaContainer').appendChild(img);

      const option = document.createElement('option');
      option.value = uniqueId;
      option.textContent = fileName;
      document.getElementById('mediaSelector').appendChild(option);

      img.addEventListener('click', () => {
        selectMedia(uniqueId);
      });
    }

    function createVideoElement(url, fileName, uniqueId) {
  const video = document.createElement('video');
  video.src = url;
  video.controls = true;
  video.autoplay = true; // Ensure video plays automatically
  video.className = 'uploaded-media';
  video.id = uniqueId;
  video.style.position = 'absolute';
  video.style.transform = 'scale(0.3)'; // Center and scale the video

  document.getElementById('mediaContainer').appendChild(video);

  const option = document.createElement('option');
  option.value = uniqueId;
  option.textContent = fileName;
  document.getElementById('mediaSelector').appendChild(option);

  video.addEventListener('click', () => {
    selectMedia(uniqueId);
  });
}


    function moveMedia(direction) {
      if (!selectedMediaId) return;

      const media = document.getElementById(selectedMediaId);
      if (!media) return;

      const step = 20; // Pixels to move per nudge

      switch (direction) {
        case 'up':
          mediaY -= step;
          break;
        case 'down':
          mediaY += step;
          break;
        case 'left':
          mediaX -= step;
          break;
        case 'right':
          mediaX += step;
          break;
      }

      // Apply the new position
      media.style.transform = `translate(${mediaX}px, ${mediaY}px) scale(0.3)`;
    }

    function selectMedia(mediaId) {
      selectedMediaId = mediaId;
      mediaX = 0;
      mediaY = 0;
      const media = document.getElementById(mediaId);
    }

    document.addEventListener('keydown', (event) => {
      switch (event.key) {
        case 'ArrowUp':
          moveMedia('up');
          break;
        case 'ArrowDown':
          moveMedia('down');
          break;
        case 'ArrowLeft':
          moveMedia('left');
          break;
        case 'ArrowRight':
          moveMedia('right');
          break;
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.uploaded-media').forEach(media => {
        media.addEventListener('click', () => selectMedia(media.id));
      });
    });

    document.getElementById('mediaSelector').addEventListener('change', (event) => {
      const mediaId = event.target.value;
      selectMedia(mediaId);
    });

    function resetMedia() {
      const container = document.getElementById('mediaContainer');
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      // Clear dropdown options except for the first one
      const dropdown = document.getElementById('mediaSelector');
      while (dropdown.childElementCount > 1) {
        dropdown.removeChild(dropdown.lastChild);
      }

      selectedMediaId = null;
    }

    document.getElementById('uploadMedia').addEventListener('change', handleFileUpload);
    document.getElementById('resetMediaButton').addEventListener('click', resetMedia);

    // Toggle HUD visibility
    function toggleHUD() {
      const hud = document.getElementById('hud');
      const collapseButton = document.getElementById('collapseButton');
      if (hud.style.display === 'none') {
        hud.style.display = 'flex';
        collapseButton.style.opacity = '0.5';
      } else {
        hud.style.display = 'none';
        collapseButton.style.opacity = '1';
      }
    }

    // Make moveMedia function globally accessible
    window.moveMedia = moveMedia;
    window.toggleHUD = toggleHUD;

  </script>
  <link rel="stylesheet" href="./style.css">
  <style>
    #container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: black;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      z-index: 100001;
    }


    #hud {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      display: flex;
      gap: 10px;
      transition: opacity 0.3s;
    }

    #collapseButton {
      position: fixed;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      background: transparent;
      border: none;
      color: black;
      font-size: 24px;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.6s;
    }
  </style>
</head>

<body>
  <div id="container"></div>
  <div id="mediaContainer" class="movable-media" style="position: absolute; width: 100%; height: 100%;"></div>



  <div id="hud">

  <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 99999; display: flex; gap: 10px;">
    <button style="z-index: 9999999; color: black; border-color: black; padding: 10px 20px; border: 2px solid black; background-color: white;" id="spawnCrowdButton">Luminate</button>
    <button style="color: black; border-color: black; padding: 10px 20px; border: 2px solid black; background-color: white;" id="changeTextureButton">Summon</button>
    <input type="file" id="uploadMedia" accept="image/*,video/*" style="display: none;" />
    <button onclick="document.getElementById('uploadMedia').click();" style="color: black; border-color: black; padding: 10px 20px; border: 2px solid black; background-color: white;">Upload Media</button>
    <button id="resetMediaButton" style="color: black; border-color: black; padding: 10px 20px; border: 2px solid black; background-color: white;">Reset Media</button>
  </div>
  <div style="position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 99999;">
    <label for="mediaSelector">Select Media:</label>
    <select id="mediaSelector" style="padding: 10px;">
      <option value="">Select media</option>
    </select>
  </div>

  <div class="arrow-buttons" style="position: fixed; bottom: 180px; left: 50%; transform: translateX(-50%); z-index: 99999;">
    <button onclick="moveMedia('up')">▲</button>
    <button onclick="moveMedia('left')">◀</button>
    <button onclick="moveMedia('right')">▶</button>
    <button onclick="moveMedia('down')">▼</button>
  </div>
  <button id="collapseButton" onclick="toggleHUD()">▼</button>

  </div>

  <canvas id="canvas"></canvas>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/gsap/3.2.6/gsap.min.js'></script>
  <script src="./peep.js"></script>
</body>

</html>
